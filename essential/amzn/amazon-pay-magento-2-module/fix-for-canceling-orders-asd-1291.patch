diff --git a/Model/CheckoutSessionManagement.php b/Model/CheckoutSessionManagement.php
index 82ca9ae..8256ab4 100755
--- a/Model/CheckoutSessionManagement.php
+++ b/Model/CheckoutSessionManagement.php
@@ -754,6 +754,41 @@ class CheckoutSessionManagement implements \Amazon\Pay\Api\CheckoutSessionManage
return $result;
}

+    /**
+     * @param OrderInterface $order
+     * @return bool
+     */
+    private function isOrderAlreadyFinalized(\Magento\Sales\Api\Data\OrderInterface $order): bool
+    {
+        $payment = $order->getPayment();
+
+        if ($payment->getAdditionalInformation('charge_permission_id')) {
+            return true;
+        }
+        if ($payment->getLastTransId() && $payment->getLastTransId() !== '') {
+            return true;
+        }
+
+        $state = $order->getState();
+        if (in_array($state, [
+            \Magento\Sales\Model\Order::STATE_PROCESSING,
+            \Magento\Sales\Model\Order::STATE_COMPLETE,
+            \Magento\Sales\Model\Order::STATE_CLOSED
+        ], true)) {
+            return true;
+        }
+
+        $this->searchCriteriaBuilder->addFilter(\Magento\Sales\Api\Data\TransactionInterface::ORDER_ID, $order->getEntityId());
+        $transactions = $this->transactionRepository->getList($this->searchCriteriaBuilder->create())->getItems();
+        foreach ($transactions as $transaction) {
+            if (in_array($transaction->getTxnType(), ['authorization', 'capture'], true)) {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
/**
* @inheritDoc
*/
@@ -805,10 +840,18 @@ class CheckoutSessionManagement implements \Amazon\Pay\Api\CheckoutSessionManage
} catch (\Exception $e) {
if (isset($order)) {
$this->closeChargePermission($amazonSessionId, $order, $e);
-                $session = $this->getAmazonSession($amazonSessionId);
-                $cancelledMessage = $this->getCanceledMessage($session);
-                $this->cancelOrder($order, $quote, $cancelledMessage);
-                $this->magentoCheckoutSession->restoreQuote();
+                // PATCH BEGIN
+                // $session = $this->getAmazonSession($amazonSessionId);
+                // $cancelledMessage = $this->getCanceledMessage($session);
+                // $this->cancelOrder($order, $quote, $cancelledMessage);
+                // $this->magentoCheckoutSession->restoreQuote();
+                if (!$this->isOrderAlreadyFinalized($order)) {
+                    $session = $this->getAmazonSession($amazonSessionId);
+                    $cancelledMessage = $this->getCanceledMessage($session);
+                    $this->cancelOrder($order, $quote, $cancelledMessage);
+                    $this->magentoCheckoutSession->restoreQuote();
+                }
+                // PATCH END
}

throw $e;
@@ -1258,9 +1301,10 @@ class CheckoutSessionManagement implements \Amazon\Pay\Api\CheckoutSessionManage
);

$completeCheckoutStatus = $amazonCompleteCheckoutResult['status'] ?? '404';
-
-        if (!preg_match('/^2\d\d$/', $completeCheckoutStatus)) {
-
+        // PATCH BEGIN
+        // if (!preg_match('/^2\d\d$/', $completeCheckoutStatus)) {
+        if (!$this->isOrderAlreadyFinalized($order) && !preg_match('/^2\d\d$/', $completeCheckoutStatus)) {
+        // PATCH END
$session = $this->amazonAdapter->getCheckoutSession(
$order->getStoreId(),
$amazonSessionId
@@ -1391,7 +1435,12 @@ class CheckoutSessionManagement implements \Amazon\Pay\Api\CheckoutSessionManage
);

$cancelledMessage = $this->getCanceledMessage($session);
-            $this->cancelOrder($order, $quote, $cancelledMessage);
+            // PATCH BEGIN
+            // $this->cancelOrder($order, $quote, $cancelledMessage);
+            if (!$this->isOrderAlreadyFinalized($order)) {
+                $this->cancelOrder($order, $quote, $cancelledMessage);
+            }
+            // PATCH END
$this->magentoCheckoutSession->restoreQuote();

$logEntryDetails = 'amazonSessionId: ' . $amazonSessionId
--
2.39.5 (Apple Git-154)
